{"version":3,"file":"video-recorder-Jl_rylIj.js","sources":["../src/plugins/video-recorder.js"],"sourcesContent":["export default hook.define({\n  name: 'Video Recorder',\n  description: 'Record video',\n  contents: [\n    {\n      type: 'config',\n      meta: ['启用视频录制', callback]\n    }\n  ]\n});\nconst valert = str => hook.toast(str);\nlet ready = false;\nlet manual = false;\nlet recording = false;\nconst video = {\n  /** @type {HTMLDivElement} */\n  container: null,\n  createUI() {\n    if (this.container) return;\n    this.container = document.createElement('div');\n    this.container.textContent = '\\ue04b';\n    Object.assign(this.container.style, {\n      background: 'rgb(139, 195, 74)',\n      color: 'rgb(240, 241, 254)',\n      borderRadius: '2vmin',\n      padding: '1vmin',\n      zIndex: '150',\n      position: 'absolute',\n      fontFamily: '\"Material Icons\"',\n      fontSize: '4vmin',\n      opacity: '0.8',\n      lineHeight: 'initial',\n      left: '100px',\n      top: '100px'\n    });\n    this.container.addEventListener('mousedown', evt => {\n      evt.preventDefault();\n      let moved = false;\n      setTimeout(() => {\n        if (!moved && !recording) longpress();\n        moved = true;\n      }, 500);\n      const onmove = getMoveFn(this.container, evt, () => moved = true);\n      window.addEventListener('mousemove', onmove);\n      window.addEventListener('mouseup', () => {\n        window.removeEventListener('mousemove', onmove);\n        if (!moved) click();\n        moved = true;\n      }, { once: true });\n    });\n    this.container.addEventListener('touchstart', evt => {\n      evt.preventDefault();\n      let moved = false;\n      setTimeout(() => {\n        if (!moved && !recording) longpress();\n        moved = true;\n      }, 500);\n      const onmove = getMoveFn(this.container, evt, () => moved = true);\n      window.addEventListener('touchmove', onmove, { passive: false });\n      window.addEventListener('touchend', () => {\n        window.removeEventListener('touchmove', onmove);\n        if (!moved) click();\n        moved = true;\n      }, { once: true });\n    });\n    hook.app.stage.appendChild(this.container);\n  },\n  destroyUI() {\n    if (!this.container) return;\n    this.container.remove();\n    this.container = null;\n  },\n  msdest: null,\n  chunks: [],\n  objectURL: null,\n  fileName: null,\n  fileSize: null,\n  checkSupport() {\n    const f1 = (self.AudioContext || self.webkitAudioContext).prototype.createMediaStreamDestination;\n    const f2 = HTMLCanvasElement.prototype.captureStream;\n    const f3 = self.MediaRecorder;\n    return f1 && f2 && f3;\n  },\n  record() {\n    const { audio: { actx }, app: { canvas } } = hook;\n    if (!this.msdest) this.msdest = actx.createMediaStreamDestination();\n    hook.audio.msdest = this.msdest;\n    const support = [\n      'video/mp4;codecs=avc1',\n      'video/mp4;codecs=mp4a',\n      'video/webm;codecs=vp9,pcm',\n      'video/webm;codecs=vp8,pcm',\n      'video/webm;codecs=vp9,opus',\n      'video/webm;codecs=vp8,opus'\n    ].find(n => MediaRecorder.isTypeSupported(n));\n    const cStream = canvas.captureStream();\n    const aStream = this.msdest.stream;\n    const mixStream = new MediaStream([cStream.getVideoTracks()[0], aStream.getAudioTracks()[0]]);\n    try {\n      const recorder = new MediaRecorder(mixStream, {\n        videoBitsPerSecond: 2e7,\n        mimeType: support || ''\n      }); // mixStream\n      recorder.ondataavailable = evt => evt.data && evt.data.size && this.chunks.push(evt.data);\n      recorder.onstop = () => {\n        // mixStream.getTracks().forEach(n => n.stop());\n        cStream.getTracks().forEach(n => n.stop());\n        if (this.chunks.length) {\n          if (this.objectURL) {\n            URL.revokeObjectURL(this.objectURL);\n            this.objectURL = null;\n          }\n          const blob = new Blob(this.chunks, { type: recorder.mimeType });\n          this.objectURL = URL.createObjectURL(blob);\n          this.fileName = `${Math.floor(Date.now() / 1e3)}.${support.match(/\\/(.+)?;/)[1]}`;\n          this.fileSize = blob.size;\n          this.chunks.length = 0;\n          longpress();\n        } else valert('Recording Failed: No Data Available');\n      };\n      recorder.start();\n      recording = true;\n      this.stop = () => {\n        recorder.stop();\n        recording = false;\n      };\n    } catch (e) {\n      valert(`Recording Failed: ${e.message}`);\n    }\n  },\n  stop() {}\n};\nfunction click() {\n  if (ready) {\n    if (recording) {\n      video.container.style.background = 'rgb(139, 195, 74)';\n      video.stop();\n    } else {\n      video.container.style.background = 'rgb(195, 75, 79)';\n      video.record();\n    }\n  } else {\n    manual = !manual;\n    if (manual) video.container.textContent = '\\ue04c';\n    else video.container.textContent = '\\ue04b';\n  }\n}\nfunction longpress() {\n  const toast = hook.fireModal('<p>录制预览</p>', '');\n  const src = video.objectURL;\n  if (!src) {\n    toast.innerHTML = '<p>当前无可用数据</p>';\n    return;\n  }\n  // preview window\n  const elem1 = document.createElement('video');\n  elem1.style.width = '100%';\n  elem1.src = src;\n  elem1.controls = true;\n  toast.appendChild(elem1);\n  // download anchor\n  const elem2 = document.createElement('a');\n  elem2.style.display = 'inline-block';\n  elem2.style.margin = '1em 0';\n  elem2.href = src;\n  elem2.download = video.fileName;\n  elem2.textContent = `保存到本地(${bytefm(video.fileSize)})`;\n  toast.appendChild(elem2);\n}\n/**\n * @param {HTMLInputElement} checkbox\n * @param {HTMLDivElement} container\n */\nfunction callback(checkbox, container) {\n  if (!video.checkSupport()) {\n    checkbox.checked = false;\n    container.classList.add('disabled');\n    container.querySelector('label').textContent += '(当前设备或浏览器不支持)';\n    return;\n  }\n  checkbox.addEventListener('change', () => {\n    if (checkbox.checked) {\n      video.createUI();\n      hook.before.set('video', () => {\n        ready = true;\n        if (!manual) click();\n      });\n      hook.end.set('video', () => {\n        if (recording) click();\n        ready = false;\n      });\n    } else {\n      video.destroyUI();\n      hook.before.delete('video');\n      hook.end.delete('video');\n    }\n  });\n  hook.status.reg('enableVideoRecorder', checkbox);\n}\n/** @param {HTMLDivElement} div */\nfunction getMoveFn(div, evt, onmove) {\n  /** @type {MouseEvent|Touch} */\n  const evt1 = evt.changedTouches ? evt.changedTouches[0] : evt;\n  const cx = evt1.pageX;\n  const cy = evt1.pageY;\n  const sx = div.offsetLeft;\n  const sy = div.offsetTop;\n  const dw = div.offsetWidth / 2;\n  const dh = div.offsetHeight / 2;\n  const parent = div.parentElement;\n  return function(evt2) {\n    /** @type {MouseEvent|Touch} */\n    const evt3 = evt2.changedTouches ? evt2.changedTouches[0] : evt2;\n    if (evt3.movementX === 0 && evt3.movementY === 0) return; // 踩坑：新版浏览器按下鼠标即使不移动也会定期触发mousemove事件\n    const dx = sx + evt3.pageX - cx + dw;\n    const dy = sy + evt3.pageY - cy + dh;\n    const pw = dw / parent.offsetWidth * 100;\n    const ph = dh / parent.offsetHeight * 100;\n    const px = dx / parent.offsetWidth * 100;\n    const py = dy / parent.offsetHeight * 100;\n    div.style.left = px > 50 ? 'auto' : `${Math.max(0, px - pw)}%`;\n    div.style.right = px > 50 ? `${100 - Math.min(100, px + pw)}%` : 'auto';\n    div.style.top = py > 50 ? 'auto' : `${Math.max(0, py - ph)}%`;\n    div.style.bottom = py > 50 ? `${100 - Math.min(100, py + ph)}%` : 'auto';\n    onmove();\n  };\n}\n// byte转人类可读\nfunction bytefm(byte = 0) {\n  let result = byte;\n  if (result < 1024) return `${result}B`;\n  if ((result /= 1024) < 1024) return `${result.toFixed(2)}KB`;\n  if ((result /= 1024) < 1024) return `${result.toFixed(2)}MB`;\n  if ((result /= 1024) < 1024) return `${result.toFixed(2)}GB`;\n  if ((result /= 1024) < 1024) return `${result.toFixed(2)}TB`;\n  if ((result /= 1024) < 1024) return `${result.toFixed(2)}PB`;\n  if ((result /= 1024) < 1024) return `${result.toFixed(2)}EB`;\n  if ((result /= 1024) < 1024) return `${result.toFixed(2)}ZB`;\n  if ((result /= 1024) < 1024) return `${result.toFixed(2)}YB`;\n  result /= 1024; return `${result}BB`;\n}\n"],"names":["videoRecorder","hook","define","name","description","contents","type","meta","checkbox","container","video","checkSupport","checked","classList","add","querySelector","textContent","addEventListener","createUI","before","set","ready","manual","click","end","recording","destroyUI","delete","status","reg","valert","str","toast","this","document","createElement","Object","assign","style","background","color","borderRadius","padding","zIndex","position","fontFamily","fontSize","opacity","lineHeight","left","top","evt","preventDefault","moved","setTimeout","longpress","onmove","getMoveFn","window","removeEventListener","once","passive","app","stage","appendChild","remove","msdest","chunks","objectURL","fileName","fileSize","f1","self","AudioContext","webkitAudioContext","prototype","createMediaStreamDestination","f2","HTMLCanvasElement","captureStream","f3","MediaRecorder","record","audio","actx","canvas","support","find","n","isTypeSupported","cStream","aStream","stream","mixStream","MediaStream","getVideoTracks","getAudioTracks","recorder","videoBitsPerSecond","mimeType","ondataavailable","data","size","push","onstop","getTracks","forEach","stop","length","URL","revokeObjectURL","blob","Blob","createObjectURL","Math","floor","Date","now","match","start","e","message","fireModal","src","innerHTML","elem1","width","controls","elem2","display","margin","href","download","byte","result","toFixed","bytefm","div","evt1","changedTouches","cx","pageX","cy","pageY","sx","offsetLeft","sy","offsetTop","dw","offsetWidth","dh","offsetHeight","parent","parentElement","evt2","evt3","movementX","movementY","dx","dy","pw","ph","px","py","max","right","min","bottom"],"mappings":"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"}