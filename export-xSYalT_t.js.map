{"version":3,"file":"export-xSYalT_t.js","sources":["../src/plugins/export.js"],"sourcesContent":["export default hook.define({\n  name: 'Export',\n  description: 'Export Chart as JSON',\n  contents: [\n    {\n      type: 'command',\n      meta: ['/dl', callback]\n    }\n  ]\n});\nfunction callback() {\n  if (!hook.app.chart) {\n    hook.toast('请先播放谱面');\n    return;\n  }\n  const a = document.createElement('a');\n  const text = JSON.stringify(chartify(hook.app.chart));\n  a.href = URL.createObjectURL(new Blob([text], { type: 'application/json' }));\n  a.download = `chart_${Date.now()}.json`;\n  a.click();\n}\n/**\n * 导出json\n * @param {ChartPGS} json\n */\nfunction chartify(json) {\n  const newChart = {\n    formatVersion: 3,\n    offset: json.offset,\n    numOfNotes: json.numOfNotes,\n    judgeLineList: []\n  };\n  for (const line of json.judgeLineList) {\n    /** @type {JudgeLinePGS} */\n    const newLine = {\n      numOfNotes: line.numOfNotes,\n      numOfNotesAbove: line.numOfNotesAbove,\n      numOfNotesBelow: line.numOfNotesBelow,\n      bpm: line.bpm,\n      speedEvents: [],\n      notesAbove: [],\n      notesBelow: [],\n      judgeLineDisappearEvents: [],\n      judgeLineMoveEvents: [],\n      judgeLineRotateEvents: []\n    };\n    for (const evt of line.speedEvents) {\n      if (evt.startTime === evt.endTime) continue;\n      const newEvent = {};\n      newEvent.startTime = evt.startTime;\n      newEvent.endTime = evt.endTime;\n      newEvent.value = frix(evt.value);\n      newEvent.floorPosition = frix(evt.floorPosition);\n      newLine.speedEvents.push(newEvent);\n    }\n    for (const note of line.notesAbove) {\n      const newNote = {};\n      newNote.type = note.type;\n      newNote.time = note.time;\n      newNote.positionX = frix(note.positionX);\n      newNote.holdTime = note.holdTime;\n      newNote.speed = frix(note.speed);\n      newNote.floorPosition = frix(note.floorPosition);\n      newLine.notesAbove.push(newNote);\n    }\n    for (const note of line.notesBelow) {\n      const newNote = {};\n      newNote.type = note.type;\n      newNote.time = note.time;\n      newNote.positionX = frix(note.positionX);\n      newNote.holdTime = note.holdTime;\n      newNote.speed = frix(note.speed);\n      newNote.floorPosition = frix(note.floorPosition);\n      newLine.notesBelow.push(newNote);\n    }\n    for (const evt of line.judgeLineDisappearEvents) {\n      if (evt.startTime === evt.endTime) continue;\n      const newEvent = {};\n      newEvent.startTime = evt.startTime;\n      newEvent.endTime = evt.endTime;\n      newEvent.start = frix(evt.start);\n      newEvent.end = frix(evt.end);\n      newLine.judgeLineDisappearEvents.push(newEvent);\n    }\n    for (const evt of line.judgeLineMoveEvents) {\n      if (evt.startTime === evt.endTime) continue;\n      const newEvent = {};\n      newEvent.startTime = evt.startTime;\n      newEvent.endTime = evt.endTime;\n      newEvent.start = frix(evt.start);\n      newEvent.end = frix(evt.end);\n      newEvent.start2 = frix(evt.start2);\n      newEvent.end2 = frix(evt.end2);\n      newLine.judgeLineMoveEvents.push(newEvent);\n    }\n    for (const evt of line.judgeLineRotateEvents) {\n      if (evt.startTime === evt.endTime) continue;\n      const newEvent = {};\n      newEvent.startTime = evt.startTime;\n      newEvent.endTime = evt.endTime;\n      newEvent.start = frix(evt.start);\n      newEvent.end = frix(evt.end);\n      newLine.judgeLineRotateEvents.push(newEvent);\n    }\n    newChart.judgeLineList.push(newLine);\n  }\n  return newChart;\n}\nfunction frix(num) {\n  const fn = Math.fround(num);\n  if (!isFinite(fn)) return null;\n  for (let i = 1; i < 1e3; i++) {\n    const str = fn.toPrecision(i);\n    const nstr = Number(str);\n    if (Math.fround(nstr) === fn) {\n      if (parseFloat(str.slice(-1)) !== 3) return nstr;\n      const nstr2 = parseFloat(str.slice(0, -1) + 2);\n      if (fn - nstr2 === nstr - fn && Math.fround(nstr2) === fn) {\n        return nstr2;\n      }\n      return nstr;\n    }\n  }\n  throw new Error('frix error');\n}\n"],"names":["_export","hook","define","name","description","contents","type","meta","app","chart","toast","a","document","createElement","text","JSON","stringify","json","newChart","formatVersion","offset","numOfNotes","judgeLineList","line","newLine","numOfNotesAbove","numOfNotesBelow","bpm","speedEvents","notesAbove","notesBelow","judgeLineDisappearEvents","judgeLineMoveEvents","judgeLineRotateEvents","evt","startTime","endTime","newEvent","value","frix","floorPosition","push","note","newNote","time","positionX","holdTime","speed","start","end","start2","end2","chartify","href","URL","createObjectURL","Blob","download","Date","now","click","num","fn","Math","fround","isFinite","i","str","toPrecision","nstr","Number","parseFloat","slice","nstr2","Error"],"mappings":"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"}